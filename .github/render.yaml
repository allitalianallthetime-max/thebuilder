# render.yaml — The Builder: Full Microservices Deployment
# =========================================================
# Drop this in your repo root. Render will detect and configure all services.
# Fill in the env var values in the Render dashboard (or use render secrets).

services:

  # ── 1. Streamlit UI ──────────────────────────────────────────────────────
  - type: web
    name: builder-ui
    env: python
    buildCommand: pip install -r requirements-ui.txt
    startCommand: streamlit run app.py --server.port $PORT --server.address 0.0.0.0
    envVars:
      - key: MASTER_KEY
        sync: false                          # Set in Render dashboard — NO DEFAULT
      - key: STRIPE_PAYMENT_URL
        sync: false
      - key: APP_URL
        sync: false
      - key: AUTH_SERVICE_URL
        fromService:
          name: builder-auth
          type: web
          property: host
      - key: AI_SERVICE_URL
        fromService:
          name: builder-ai
          type: web
          property: host
      - key: INTERNAL_API_KEY
        sync: false                          # Shared secret — set once, use everywhere

  # ── 2. Auth Service ───────────────────────────────────────────────────────
  - type: web
    name: builder-auth
    env: python
    buildCommand: pip install -r requirements-services.txt
    startCommand: uvicorn auth_service:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: INTERNAL_API_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: builder-db
          property: connectionString
      - key: JWT_SECRET
        generateValue: true                  # Render auto-generates a secure value
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: APP_URL
        sync: false

  # ── 3. AI Service ─────────────────────────────────────────────────────────
  - type: web
    name: builder-ai
    env: python
    buildCommand: pip install -r requirements-services.txt
    startCommand: uvicorn ai_service:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: GROQ_API_KEY
        sync: false
      - key: INTERNAL_API_KEY
        sync: false
      - key: DATABASE_URL
        fromDatabase:
          name: builder-db
          property: connectionString
      - key: DAILY_BUILD_LIMIT
        value: "20"
      - key: GROQ_MODEL
        value: "llama-3.3-70b-versatile"

  # ── 4. Billing Service ────────────────────────────────────────────────────
  - type: web
    name: builder-billing
    env: python
    buildCommand: pip install -r requirements-services.txt
    startCommand: uvicorn billing_service:app --host 0.0.0.0 --port $PORT
    healthCheckPath: /health
    envVars:
      - key: STRIPE_WEBHOOK_SEC
        sync: false                          # From Stripe dashboard → Webhooks
      - key: STRIPE_SECRET_KEY
        sync: false                          # sk_live_... or sk_test_...
      - key: INTERNAL_API_KEY
        sync: false
      - key: AUTH_SERVICE_URL
        fromService:
          name: builder-auth
          type: web
          property: host
      - key: APP_URL
        sync: false

  # ── 5. Scheduler Worker (Cron Job) ────────────────────────────────────────
  - type: cron
    name: builder-scheduler
    env: python
    buildCommand: pip install -r requirements-services.txt
    schedule: "0 9 * * *"                   # 9am UTC daily
    command: python scheduler_worker.py
    envVars:
      - key: AUTH_SERVICE_URL
        fromService:
          name: builder-auth
          type: web
          property: host
      - key: INTERNAL_API_KEY
        sync: false
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        sync: false
      - key: APP_URL
        sync: false
      - key: STRIPE_PAYMENT_URL
        sync: false

# ── Database ────────────────────────────────────────────────────────────────
databases:
  - name: builder-db
    plan: free                               # Upgrade to starter ($7/mo) for production
